steps:
  # Step 1: Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'europe-west1-docker.pkg.dev/regal-framework-475315-m1/docker-repo/ub-travel-services-frontend:${SHORT_SHA}'
      - '-t'
      - 'europe-west1-docker.pkg.dev/regal-framework-475315-m1/docker-repo/ub-travel-services-frontend:latest'
      - '.'
    id: 'build-image'

  # Step 2: Push both tags to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '--all-tags'
      - 'europe-west1-docker.pkg.dev/regal-framework-475315-m1/docker-repo/ub-travel-services-frontend'
    id: 'push-images'
    waitFor: ['build-image']

  # Step 3: Clone the Terraform infrastructure repository
  - name: 'gcr.io/cloud-builders/git'
    secretEnv: ['GITHUB_TOKEN']
    entrypoint: 'bash'
    args:
      - -c
      - |
        git clone https://$$GITHUB_TOKEN@github.com/HristevMartin/constructionPlatformInfra.git /workspace/infra
    id: 'clone-infra-repo'

  # Step 4: Configure git
  - name: 'gcr.io/cloud-builders/git'
    entrypoint: 'bash'
    args:
      - -c
      - |
        cd /workspace/infra
        git config user.email "cloudbuild@gcp.com"
        git config user.name "Cloud Build"
    id: 'configure-git'
    waitFor: ['clone-infra-repo']

  # Step 5: Debug - List directory structure
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - -c
      - |
        echo "=== Listing /workspace/infra structure ==="
        ls -la /workspace/infra/
        echo ""
        echo "=== Looking for terraform.tfvars files ==="
        find /workspace/infra -name "terraform.tfvars" -type f
        echo ""
        echo "=== Directory tree ==="
        find /workspace/infra -type d | head -20
    id: 'debug-structure'
    waitFor: ['configure-git', 'push-images']

  # Step 6: Update the Terraform variable with new image
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - -c
      - |
        cd /workspace/infra
        
        # Find the terraform.tfvars file
        TFVARS_FILE="$(find . -name 'terraform.tfvars' -type f | head -1)"
        echo "Found terraform.tfvars at: $TFVARS_FILE"
        
        # Update the image in terraform.tfvars
        NEW_IMAGE="europe-west1-docker.pkg.dev/regal-framework-475315-m1/docker-repo/ub-travel-services-frontend:${SHORT_SHA}"
        
        # Update terraform.tfvars file
        sed -i "s|frontend_simple_image_name = \".*\"|frontend_simple_image_name = \"$NEW_IMAGE\"|g" "$TFVARS_FILE"
        
        echo "=== Updated terraform.tfvars ==="
        cat "$TFVARS_FILE" | grep frontend_simple_image_name
    id: 'update-terraform-vars'
    waitFor: ['debug-structure']

  # Step 7: Initialize Terraform
  - name: 'hashicorp/terraform:1.6'
    entrypoint: 'sh'
    args:
      - -c
      - |
        # Find the directory containing terraform.tfvars
        cd /workspace/infra
        TFVARS_DIR=$$(find . -name "terraform.tfvars" -type f | head -1 | xargs dirname)
        echo "Found terraform directory at: $$TFVARS_DIR"
        cd $$TFVARS_DIR
        terraform init -input=false
    id: 'terraform-init'
    waitFor: ['update-terraform-vars']

  # Step 8: Validate Terraform
  - name: 'hashicorp/terraform:1.6'
    entrypoint: 'sh'
    args:
      - -c
      - |
        cd /workspace/infra
        TFVARS_DIR=$$(find . -name "terraform.tfvars" -type f | head -1 | xargs dirname)
        cd $$TFVARS_DIR
        terraform validate
    id: 'terraform-validate'
    waitFor: ['terraform-init']

  # Step 9: Plan Terraform changes
  - name: 'hashicorp/terraform:1.6'
    entrypoint: 'sh'
    args:
      - -c
      - |
        cd /workspace/infra
        TFVARS_DIR=$$(find . -name "terraform.tfvars" -type f | head -1 | xargs dirname)
        cd $$TFVARS_DIR
        terraform plan -target=module.frontend_simple -out=tfplan -input=false
        echo "=== Terraform Plan Summary ==="
        terraform show -no-color tfplan
    id: 'terraform-plan'
    waitFor: ['terraform-validate']

  # Step 10: Apply Terraform changes (deploy to Cloud Run)
  - name: 'hashicorp/terraform:1.6'
    entrypoint: 'sh'
    args:
      - -c
      - |
        cd /workspace/infra
        TFVARS_DIR=$$(find . -name "terraform.tfvars" -type f | head -1 | xargs dirname)
        cd $$TFVARS_DIR
        terraform apply -auto-approve -input=false tfplan
        echo "=== Deployment Complete ==="
        terraform output -json
    id: 'terraform-apply'
    waitFor: ['terraform-plan']

  # Step 11: Verify deployment
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - -c
      - |
        echo "=== Cloud Run Service Status ==="
        gcloud run services describe trade-harmony-frontend-simple \
          --region=europe-west1 \
          --format="table(status.url,status.conditions[0].type,status.conditions[0].status)"
    id: 'verify-deployment'
    waitFor: ['terraform-apply']

# Use Secret Manager for GitHub token
availableSecrets:
  secretManager:
    - versionName: projects/regal-framework-475315-m1/secrets/github-token/versions/latest
      env: 'GITHUB_TOKEN'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

timeout: '1800s'